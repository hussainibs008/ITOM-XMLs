<probes>
<probe id="1a9c233dc0a8000b005c58d007c94a03" name="WMI: Active Connections" order="1" topic="WMIRunner">
<parameters>
<parameter name="WMI_ActiveConnections.js" value=" /********************************************** * Use Service-now.com WMIAPI to gather stats * This script requires the admin share (admin$) enabled and point to the windows system directory (like \WINDOWS or \WINNT). ***********************************************/ var CMD_RETRIES = 3; var FOR_READING = 1; var OUTPUT_FILE = "netstat_output.txt"; var DEBUG = false; var MAX_TIMEOUT = 60000; //60 seconds; This timeout dictates how long each command can run. var scanner = getScanner(); if (scanner) var output = run(); scanner.appendToRoot("output", output); /******************************************* * Function definitions ******************************************/ function run() { var sysDir = "C:\\WINDOWS\\system32"; sysDir = setSystemDirectory(scanner.fetchTable("Win32_OperatingSystem")); // Running the netstat command and pipe the output to a file and read the file back... // the "2>&1" redirect both stdout and stderr to the file executeCommand(sysDir + "\\cmd.exe /c netstat.exe -ano > %SystemRoot%\\temp\\" + OUTPUT_FILE + " 2>&1"); var output = readFile(OUTPUT_FILE); // check if the output is actually connections, or the netstat usage page is shown... if (output.indexOf("NETSTAT") > -1) { // Most likely the -o option is not supported on a 2000. Re-run and log it. displayWarningOnOption(output); executeCommand(sysDir + "\\cmd.exe /c netstat.exe -anp TCP > %SystemRoot%\\temp\\" + OUTPUT_FILE + " 2>&1"); output = readFile(OUTPUT_FILE); } //Clean up the temp file created... executeCommand(sysDir + "\\cmd.exe /c del %SystemRoot%\\temp\\" + OUTPUT_FILE); return output; } function setSystemDirectory(items) { for(var i = 0; i < items.length; i++) { var item = items[i]; sysDir = item.SystemDirectory; } return sysDir; } function executeCommand(command) { for(var i = 0; i < CMD_RETRIES; i++) { var oProcess = GetObject('winmgmts:\\\\' + gCurrentMachine + '\\root\\CIMV2:Win32_Process') var oMethod = oProcess.Methods_.Item("Create"); var oInParam = oMethod.InParameters.SpawnInstance_(); oInParam.CommandLine = command; var oOutParam = oProcess.ExecMethod_(oMethod.Name, oInParam); var retValue = oOutParam.ReturnValue; var pid = oOutParam.ProcessID; debug("Running command: " + command); debug("The return value is " + retValue); debug("The process ID is " + pid); //If the command returns successfully, let's get out of here... if (retValue == 0) break; } waitForProcessComplete(pid); } function readFile(fileName) { var fileObj = new ActiveXObject("Scripting.FileSystemObject"); try { var objTextFile = fileObj.OpenTextFile("\\\\" + gCurrentMachine + "\\admin$\\temp\\" + fileName, FOR_READING); var output = objTextFile.ReadAll(); objTextFile.close(); } catch (e) { return "Exception in readFile: " + e.message; } return output; } function waitForProcessComplete(pid) { var myDate = new Date(); myDate.setTime(myDate.getTime()+MAX_TIMEOUT) while (processExists(pid) == true && ((new Date()) < myDate)) WScript.Sleep(100); } function processExists(pid) { try { var wql = "SELECT * FROM Win32_Process WHERE ProcessId=" + pid; debug("Running wql query: " + wql); var procs = GetObject('WinMgmts:\\\\' + gCurrentMachine + "\\root\\CIMV2").ExecQuery(wql); for (var en = new Enumerator(procs); !en.atEnd(); en.moveNext()) return true; return false; } catch (e) { return false; } } function displayWarningOnOption(output) { var options = ["-a", "-n", "-o", "-p"]; for (var i=0; i<options.length; i++) { var warning = ""; var option = options[i]; if (output.indexOf(option) > -1) continue; warning = "'" + option + "' is not supported on the version of the netstat."; if (option == "-o") warning += " Without the '-o' option, connections do not have process IDs associated them."; if (warning != "") scanner.addWarning(warning); } } function debug(msg) { if (DEBUG == true) WScript.echo(msg); } "/>
<parameter name="WMI_ActiveConnections.ps1" value="launchProcess -computer $computer -cred $cred -command 'netstat.exe -ano'"/>
</parameters>
</probe>
<probe id="8ef5a7990a0a0ba5007a9d00e48e5e00" name="WMI: Active Processes" order="1" topic="WMIRunner">
<parameters>
<parameter name="WMI_FetchData" value="Win32_Process.Caption,Win32_Process.CommandLine,Win32_Process.CreationDate,Win32_Process.Description,Win32_Process.ExecutablePath,Win32_Process.Name,Win32_Process.ParentProcessId,Win32_Process.ProcessId,Win32_Process.Priority"/>
<parameter name="running_process_filter" value="[{"isCaseSensitive":1,"orOps":[[{"field":"name","op":"IN","value":["unsecapp.exe","fontdrvhost.exe","monitoringhost.exe","smss.exe","csrss.exe","dllhost.exe","conhost.exe","searchprotocolhost.exe","dwm.exe","wmiprvse.exe","winlogon.exe","wlanext.exe","explorer.exe","system idle process","wininit.exe","lsass.exe","searchfilterhost.exe","services.exe","taskhostw.exe","spoolsv.exe","wudfhost.exe","searchindexer.exe","scnotification.exe","logonui.exe","sihost.exe"]}]]},{"isCaseSensitive":1,"orOps":[[{"orOps":[{"field":"name","op":"IN","value":["svchost.exe"]}]},{"orOps":[[{"field":"name","op":"=","value":"svchost.exe"},{"field":"parameters","op":"DOES NOT CONTAIN","value":"iissvcs"}]]}]]}]"/>
</parameters>
</probe>
<parameters>
<parameter name="mid_selector_details" value="{"mode":"specific_mid"}"/>
<parameter name="protocol" value="WMI"/>
<parameter name="glide.xmlhelper.trim.enable" value="true"/>
<parameter name="port" value="5986"/>
<parameter name="used_by_discovery" value="true"/>
<parameter name="os_type" value="WINDOWS"/>
<parameter name="ci_sys_id" value="93a474af1e013210da733081287ed600"/>
<parameter name="ecc_breadcrumbs" value="7aa434af9f0132107f44b8b13024ab96"/>
<parameter name="probe" value="edae4993ef31010098d5925495c0fb6c"/>
<parameter name="limited.resource.powershell" value="1"/>
<parameter name="limited.resource.powershell{source}" value="1"/>
<parameter name="classification_probe" value="b11360600a0a0ba500c41bcbae55c5c4"/>
<parameter name="admin_share_access" value="true"/>
<parameter name="target_powershell_access" value="true"/>
<parameter name="deviceHistoryParams" value="{"result":{"ip":"10.253.64.183","active":true,"alive":true,"hostName":null,"domainName":null,"scanners":[{"result":"open","service":"epmap","protocol":"tcp","name":"GenericTCP","port":"135","portProbe":"wmi","contents":{},"scanners":[],"hostName":null,"domainName":null},{"result":"open","service":"winrm_ssl","protocol":"tcp","name":"HTTPS","port":"5986","portProbe":"winrm_ssl","contents":{},"scanners":[],"hostName":null,"domainName":null},{"result":"unresolved","service":"ms-nb-ns","protocol":"udp","name":"NBT","port":"137","portProbe":"wins","contents":{},"scanners":[],"hostName":null,"domainName":null},{"result":"unresolved","service":"dns","protocol":"udp","name":"DNS","port":"53","portProbe":"dns","contents":{},"scanners":[],"hostName":null,"domainName":null},{"result":"refused","service":"slp","protocol":"udp","name":"SLP","port":"427","portProbe":"slp","contents":{},"scanners":[],"hostName":null,"domainName":null},{"result":"refused","service":"wbem_https","protocol":"tcp","name":"GenericTCP","port":"5989","portProbe":"wbem","contents":{},"scanners":[],"hostName":null,"domainName":null},{"result":"open","service":"winrm","protocol":"tcp","name":"HTTP","port":"5985","portProbe":"winrm","contents":{"response_code":"404","Server":"Microsoft-HTTPAPI/2.0","http_version":"HTTP/1.1","response_text":"Not Found"},"scanners":[],"hostName":null,"domainName":null}]},"ecc_queue":"8654f8eb9f0132107f44b8b13024abec","errMsgs":[],"status":{"valid":true,"sysID":"1c5478eb9f0132107f44b8b13024ab9d","number":"DIS0010012","scheduleID":"0f73306b9f0132107f44b8b13024ab94","jobID":"1854b0eb9f0132107f44b8b13024ab1f","discover":"CIs","include":null,"description":"Discover Now","createdOn":"2025-11-12 10:51:15","updatedOn":"2025-11-12 10:51:15","useSnmpVersion":"all","source":"Discover_now_schedule","priority":"2","includeAlive":false,"logStateChanges":false,"scratchpad":{"behavior:0":1,"unique":"e054b8eb9f0132107f44b8b13024ab3d"}}}"/>
</parameters>
</probes>
